<?php namespace App\Http\Fetcher;

use App\Http\Syncer\ClickUpSyncer;
use App\Logger;
use App\Models\Project;
use App\Models\Settings;
use App\Models\TaskMapper;
use App\Models\UserMapper;
use App\Models\WorklogMapper;
use Illuminate\Support\Facades\Http;

class TimeDoctorFetcher
{
    const UNAUTHENTICATED_STATUS_CODE = 401;
    const MAX_TRY = 2;
    const LIMIT = 500;

    public static function getWorkLog($date, $users = [])
    {
        // return json_decode('[{"id":"2070848801","length":"6025","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"69809418","task_name":"Plan marketing 2021","task_url":"","project_id":"16836083","project_name":"NeXafe Général","start_time":"2021-09-21 07:58:40","end_time":"2021-09-21 09:39:05","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070879509","length":"4728","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67321937","task_name":"Accompagnement Marketing & Stratégique","task_url":"","project_id":"16840585","project_name":"Storetraffic - General","start_time":"2021-09-21 10:16:52","end_time":"2021-09-21 11:35:40","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070824870","length":"4276","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67521160","task_name":"Agora - development","task_url":"","project_id":"16836925","project_name":"Agora Media","start_time":"2021-09-21 05:39:28","end_time":"2021-09-21 06:50:44","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070926941","length":"3117","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"60845721","task_name":"Point Sebastien","task_url":"","project_id":"1688292","project_name":"Zerda Digital","start_time":"2021-09-21 14:54:16","end_time":"2021-09-21 15:46:13","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070871001","length":"2034","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"68376890","task_name":"ZD-Biz dev","task_url":"","project_id":"16836236","project_name":"Zerda Digital","start_time":"2021-09-21 09:39:08","end_time":"2021-09-21 10:13:02","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070842521","length":"657","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"78550738","task_name":"ZD- Academy","task_url":"","project_id":"16836236","project_name":"Zerda Digital","start_time":"2021-09-21 07:25:02","end_time":"2021-09-21 07:35:59","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070837709","length":"654","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67521160","task_name":"Agora - development","task_url":"","project_id":"16836925","project_name":"Agora Media","start_time":"2021-09-21 06:55:00","end_time":"2021-09-21 07:05:54","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070845447","length":"650","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"78550738","task_name":"ZD- Academy","task_url":"","project_id":"16836236","project_name":"Zerda Digital","start_time":"2021-09-21 07:41:35","end_time":"2021-09-21 07:52:25","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070848367","length":"365","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"68376890","task_name":"ZD-Biz dev","task_url":"","project_id":"16836236","project_name":"Zerda Digital","start_time":"2021-09-21 07:52:25","end_time":"2021-09-21 07:58:30","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070845446","length":"336","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"78550738","task_name":"ZD- Academy","task_url":"","project_id":"16836236","project_name":"Zerda Digital","start_time":"2021-09-21 07:35:59","end_time":"2021-09-21 07:41:35","edited":"0","last_modified":"","work_mode":"3"},{"id":"2070837708","length":"256","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67521160","task_name":"Agora - development","task_url":"","project_id":"16836925","project_name":"Agora Media","start_time":"2021-09-21 06:50:44","end_time":"2021-09-21 06:55:00","edited":"0","last_modified":"","work_mode":"3"},{"id":"2070839590","length":"215","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67521160","task_name":"Agora - development","task_url":"","project_id":"16836925","project_name":"Agora Media","start_time":"2021-09-21 07:07:49","end_time":"2021-09-21 07:11:24","edited":"0","last_modified":"","work_mode":"0"},{"id":"2070839589","length":"115","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67521160","task_name":"Agora - development","task_url":"","project_id":"16836925","project_name":"Agora Media","start_time":"2021-09-21 07:05:54","end_time":"2021-09-21 07:07:49","edited":"0","last_modified":"","work_mode":"3"},{"id":"2070840575","length":"115","user_id":"1352467","user_name":"Chiheb  Ben Aissa ","task_id":"67521160","task_name":"Agora - development","task_url":"","project_id":"16836925","project_name":"Agora Media","start_time":"2021-09-21 07:13:24","end_time":"2021-09-21 07:15:19","edited":"0","last_modified":"","work_mode":"0"}]', true);
        $has_next_page = true;
        $offset = 0;
        $logs = [];
        $call_count = 0;

        $settings = Settings::timedoctor();
        $access_token = $settings->access_token;

        $projects = Project::pluck('time_doctor_project_id')->toArray();
        $projects = implode(',', $projects);

        $api = env('TIME_DOCTOR_BASE_URL') . '/companies/' . env('TIME_DOCTOR_COMPANY_ID') . '/worklogs';
        do {
            Logger::verbose("fetching for offset $offset");

            $requestBody = [
                'access_token'  => $access_token,
                'offset'        => $offset,
                'limit'         => self::LIMIT,
                'consolidated'  => 0,
                'breaks_only'   => 0,
                'start_date'    => $date,
                'end_date'      => $date,
                // 'user_ids'      => '1352467' // this is for test only
                'project_ids'   => $projects,
            ];
            if (count($users)) {
                $requestBody['user_ids'] = implode(',', $users);
            }

            $request = Http::get($api, $requestBody);

            if ($request->successful()) {
                $response = $request->json();
                $count = $response['worklogs']['count'];
                $logs = array_merge($logs, $response['worklogs']['items']);
                if ($count < $offset + self::LIMIT || count($response['worklogs']['items']) == 0) {
                    $has_next_page = false;
                } else {
                    $offset += self::LIMIT;
                }
            }
            else {
                $has_next_page = false;
            }
            $call_count++;
        } while($has_next_page);

        return [
            'worklog' => $logs,
            'call_count' => $call_count
        ];
    }

    public static function getTasks($userId)
    {
        $has_next_page = true;
        $limit = 200;
        $offset = 1;
        $tasks = [];

        $settings = Settings::timedoctor();
        $access_token = $settings->access_token;
        $api = env('TIME_DOCTOR_BASE_URL') . '/companies/' . env('TIME_DOCTOR_COMPANY_ID') . "/users/$userId/tasks";

        do {
            $request = Http::get($api, [
                'access_token'  => $access_token,
                'offset'        => $offset,
                'limit'         => $limit,
                'status'        => 'all',
            ]);

            if ($request->failed() && $request->status() == self::UNAUTHENTICATED_STATUS_CODE) {
                $is_regenerated = self::setAccessToken($settings);
                if ($is_regenerated) {
                    $request = Http::get($api, [
                        'access_token'  => $access_token,
                        'offset'        => $offset,
                        'limit'         => $limit,
                        'status'        => 'all',
                    ]);
                }
            }

            if ($request->successful()) {
                $response = $request->json();
                $count = $response['count'];

                Logger::verbose("Offset: $offset, Limit: $limit, Count: ". count($response['tasks']));

                $tasks = array_merge($tasks, $response['tasks']);
                if ($count < $limit + $offset || count($response['tasks']) == 0) {
                    $has_next_page = false;
                } else {
                    $offset += $limit;
                }
            } else {
                $has_next_page = false;
            }
        } while ($has_next_page);

        return $tasks;
    }

    public static function getUsers($try = 1)
    {
        // return json_decode('[{"full_name":"Sabbir Ahmed","first_name":"Sabbir","last_name":"Ahmed","email":"sabbir25112@gmail.com","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072890","id":2072890,"user_id":2072890,"company_id":718573,"level":"admin","is_team_manager":false,"projects":{"all":{"count":"238","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072890/projects?all=1"},"currently_assigned":{"count":"0","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072890/projects?all=0"}},"tasks":{"all":{"count":0,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072890/tasks?status=all"},"active":{"count":0,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072890/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":1,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"20","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"","employee_id":null,"password_reset":null},{"full_name":"Ahmed Nabli","first_name":"Ahmed","last_name":"Nabli","email":"ahmed.nabli@zerda.store","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1938707","id":1938707,"user_id":1938707,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"2","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1938707/projects?all=1"},"currently_assigned":{"count":"2","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1938707/projects?all=0"}},"tasks":{"all":{"count":287,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1938707/tasks?status=all"},"active":{"count":287,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1938707/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/1938707.jpg","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"","password_reset":""},{"full_name":"Ali Gassab","first_name":"Ali","last_name":"Gassab","email":"ali@zerda.store","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1429386","id":1429386,"user_id":1429386,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"0","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1429386/projects?all=1"},"currently_assigned":{"count":"0","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1429386/projects?all=0"}},"tasks":{"all":{"count":58,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1429386/tasks?status=all"},"active":{"count":4,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1429386/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[{"full_name":"Ahmed Nabli","email":"ahmed.nabli@zerda.store","user_id":1938707,"company_id":718573,"level":"manager"},{"full_name":"Amal Becha","email":"amal@zerda.digital","user_id":1825018,"company_id":718573,"level":"user"},{"full_name":"Emna Zribi","email":"emna@zerda.digital","user_id":1808517,"company_id":718573,"level":"user"},{"full_name":"Joseph Ouko Ongere","email":"joseph@zerda.store","user_id":2072305,"company_id":718573,"level":"user"},{"full_name":"Mokrani Ilyes ","email":"ilyess.mokrani@zerda.digital","user_id":1835213,"company_id":718573,"level":"user"},{"full_name":"Oumaima Belatteg","email":"oumaima.belatteg@zerda.digital","user_id":1830913,"company_id":718573,"level":"user"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2018-11-21","employee_id":"","password_reset":""},{"full_name":"Amal Becha","first_name":"Amal","last_name":"Becha","email":"amal@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1825018","id":1825018,"user_id":1825018,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"3","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1825018/projects?all=1"},"currently_assigned":{"count":"3","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1825018/projects?all=0"}},"tasks":{"all":{"count":618,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1825018/tasks?status=all"},"active":{"count":609,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1825018/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Ameni Khamessi","first_name":"Ameni","last_name":"Khamessi","email":"ameni.khamessi@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1826554","id":1826554,"user_id":1826554,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"21","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1826554/projects?all=1"},"currently_assigned":{"count":"21","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1826554/projects?all=0"}},"tasks":{"all":{"count":117,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1826554/tasks?status=all"},"active":{"count":107,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1826554/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-11-28","employee_id":null,"password_reset":null},{"full_name":"Amira Br","first_name":"Amira","last_name":"Br","email":"amira@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1621162","id":1621162,"user_id":1621162,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"58","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1621162/projects?all=1"},"currently_assigned":{"count":"58","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1621162/projects?all=0"}},"tasks":{"all":{"count":214,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1621162/tasks?status=all"},"active":{"count":173,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1621162/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/1621162.jpg","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-12-30","employee_id":"","password_reset":""},{"full_name":"Aymen Klidi","first_name":"Aymen","last_name":"Klidi","email":"aymen@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1794290","id":1794290,"user_id":1794290,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"15","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1794290/projects?all=1"},"currently_assigned":{"count":"15","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1794290/projects?all=0"}},"tasks":{"all":{"count":63,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1794290/tasks?status=all"},"active":{"count":51,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1794290/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-05-07","employee_id":null,"password_reset":null},{"full_name":"Bentardeit Khouloud","first_name":"Bentardeit","last_name":"Khouloud","email":"khouloud.bentardeit@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1838153","id":1838153,"user_id":1838153,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"49","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1838153/projects?all=1"},"currently_assigned":{"count":"49","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1838153/projects?all=0"}},"tasks":{"all":{"count":658,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1838153/tasks?status=all"},"active":{"count":658,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1838153/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Chiheb Ben Aissa ","first_name":"Chiheb  Ben Aissa ","last_name":"","email":"chiheb@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352467","id":1352467,"user_id":1352467,"company_id":718573,"level":"admin","is_team_manager":false,"projects":{"all":{"count":"238","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352467/projects?all=1"},"currently_assigned":{"count":"80","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352467/projects?all=0"}},"tasks":{"all":{"count":383,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352467/tasks?status=all"},"active":{"count":235,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352467/tasks?status=active"}},"work_status":{"code":"online","info":"Agora - development","current_task":{"task_id":"2072320303","task_name":"Agora - development","start_time":"2021-09-29 15:49:35","total_time_worked":777}},"managed_users":[{"full_name":"Ahmed Nabli","email":"ahmed.nabli@zerda.store","user_id":1938707,"company_id":718573,"level":"manager"},{"full_name":"Ali Gassab","email":"ali@zerda.store","user_id":1429386,"company_id":718573,"level":"manager"},{"full_name":"Amal Becha","email":"amal@zerda.digital","user_id":1825018,"company_id":718573,"level":"user"},{"full_name":"Ameni Khamessi","email":"ameni.khamessi@zerda.digital","user_id":1826554,"company_id":718573,"level":"user"},{"full_name":"Amira Br","email":"amira@zerda.digital","user_id":1621162,"company_id":718573,"level":"user"},{"full_name":"Aymen Klidi","email":"aymen@zerda.digital","user_id":1794290,"company_id":718573,"level":"user"},{"full_name":"Bentardeit Khouloud","email":"khouloud.bentardeit@zerda.digital","user_id":1838153,"company_id":718573,"level":"user"},{"full_name":"Chourabi Mohamed","email":"mohamed@zerda.digital","user_id":1808389,"company_id":718573,"level":"user"},{"full_name":"Emna Zribi","email":"emna@zerda.digital","user_id":1808517,"company_id":718573,"level":"user"},{"full_name":"Haithem Laabidi ","email":"htm@zerda.digital","user_id":1572278,"company_id":718573,"level":"manager"},{"full_name":"Hanna Sebai","email":"hanna@zerda.digital","user_id":1634774,"company_id":718573,"level":"manager"},{"full_name":"Imed El Mokhtar","email":"imed.mokhtar@zerda.digital","user_id":2064222,"company_id":718573,"level":"user"},{"full_name":"Ines Sakkat","email":"ines.sakkat@zerda.digital","user_id":1974362,"company_id":718573,"level":"user"},{"full_name":"Joseph Ouko Ongere","email":"joseph@zerda.store","user_id":2072305,"company_id":718573,"level":"user"},{"full_name":"Mahmoud Ben Aissa","email":"mahmoud@zerda.digital","user_id":1352473,"company_id":718573,"level":"manager"},{"full_name":"Mokrani Ilyes ","email":"ilyess.mokrani@zerda.digital","user_id":1835213,"company_id":718573,"level":"user"},{"full_name":"Norchene Zemni ","email":"norchene@zerda.digital","user_id":1531444,"company_id":718573,"level":"user"},{"full_name":"Nourhen Bdioui ","email":"nourhen.bdioui@zerda.digital","user_id":1835553,"company_id":718573,"level":"user"},{"full_name":"Oumaima Belatteg","email":"oumaima.belatteg@zerda.digital","user_id":1830913,"company_id":718573,"level":"user"},{"full_name":"Ouss Romdhane","email":"romdhaneoussama2@gmail.com","user_id":1865297,"company_id":718573,"level":"admin"},{"full_name":"Sabbir Ahmed","email":"sabbir25112@gmail.com","user_id":2072890,"company_id":718573,"level":"admin"},{"full_name":"Salsabil Najjar","email":"salsabil.najjar@zerda.digital","user_id":1992398,"company_id":718573,"level":"user"},{"full_name":"Samir Kachouri ","email":"samir@zerda.digital","user_id":1572276,"company_id":718573,"level":"user"},{"full_name":"Sirine Cherif","email":"sirine_cherif@hotmail.fr","user_id":2027949,"company_id":718573,"level":"user"},{"full_name":"Younes Yahmed","email":"younes.yahmed@zerda.digital","user_id":1952789,"company_id":718573,"level":"manager"},{"full_name":"Zidane Yassine","email":"yassine.zidane@zerda.digital","user_id":1872916,"company_id":718573,"level":"manager"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"20","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Chourabi Mohamed","first_name":"Chourabi","last_name":"Mohamed","email":"mohamed@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808389","id":1808389,"user_id":1808389,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"29","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808389/projects?all=1"},"currently_assigned":{"count":"29","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808389/projects?all=0"}},"tasks":{"all":{"count":170,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808389/tasks?status=all"},"active":{"count":161,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808389/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-10-15","employee_id":null,"password_reset":null},{"full_name":"Emna Zribi","first_name":"Emna","last_name":"Zribi","email":"emna@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808517","id":1808517,"user_id":1808517,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"1","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808517/projects?all=1"},"currently_assigned":{"count":"1","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808517/projects?all=0"}},"tasks":{"all":{"count":753,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808517/tasks?status=all"},"active":{"count":744,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1808517/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"emna@zerda.digital","password_reset":"emna@zerda.digital"},{"full_name":"Haithem Laabidi ","first_name":"Haithem ","last_name":"Laabidi ","email":"htm@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572278","id":1572278,"user_id":1572278,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"98","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572278/projects?all=1"},"currently_assigned":{"count":"96","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572278/projects?all=0"}},"tasks":{"all":{"count":356,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572278/tasks?status=all"},"active":{"count":305,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572278/tasks?status=active"}},"work_status":{"code":"online","info":"NeXafe software interpretations","current_task":{"task_id":"2072317764","task_name":"NeXafe software interpretations","start_time":"2021-09-29 15:26:56","total_time_worked":2060}},"managed_users":[{"full_name":"Amira Br","email":"amira@zerda.digital","user_id":1621162,"company_id":718573,"level":"user"},{"full_name":"Nourhen Bdioui ","email":"nourhen.bdioui@zerda.digital","user_id":1835553,"company_id":718573,"level":"user"},{"full_name":"Oumaima Belatteg","email":"oumaima.belatteg@zerda.digital","user_id":1830913,"company_id":718573,"level":"user"},{"full_name":"Sirine Cherif","email":"sirine_cherif@hotmail.fr","user_id":2027949,"company_id":718573,"level":"user"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"300","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Hanna Sebai","first_name":"Hanna","last_name":"Sebai","email":"hanna@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1634774","id":1634774,"user_id":1634774,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"14","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1634774/projects?all=1"},"currently_assigned":{"count":"14","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1634774/projects?all=0"}},"tasks":{"all":{"count":164,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1634774/tasks?status=all"},"active":{"count":125,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1634774/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[{"full_name":"Ahmed Nabli","email":"ahmed.nabli@zerda.store","user_id":1938707,"company_id":718573,"level":"manager"},{"full_name":"Amal Becha","email":"amal@zerda.digital","user_id":1825018,"company_id":718573,"level":"user"},{"full_name":"Ameni Khamessi","email":"ameni.khamessi@zerda.digital","user_id":1826554,"company_id":718573,"level":"user"},{"full_name":"Amira Br","email":"amira@zerda.digital","user_id":1621162,"company_id":718573,"level":"user"},{"full_name":"Aymen Klidi","email":"aymen@zerda.digital","user_id":1794290,"company_id":718573,"level":"user"},{"full_name":"Bentardeit Khouloud","email":"khouloud.bentardeit@zerda.digital","user_id":1838153,"company_id":718573,"level":"user"},{"full_name":"Chourabi Mohamed","email":"mohamed@zerda.digital","user_id":1808389,"company_id":718573,"level":"user"},{"full_name":"Emna Zribi","email":"emna@zerda.digital","user_id":1808517,"company_id":718573,"level":"user"},{"full_name":"Haithem Laabidi ","email":"htm@zerda.digital","user_id":1572278,"company_id":718573,"level":"manager"},{"full_name":"Imed El Mokhtar","email":"imed.mokhtar@zerda.digital","user_id":2064222,"company_id":718573,"level":"user"},{"full_name":"Ines Sakkat","email":"ines.sakkat@zerda.digital","user_id":1974362,"company_id":718573,"level":"user"},{"full_name":"Mahmoud Ben Aissa","email":"mahmoud@zerda.digital","user_id":1352473,"company_id":718573,"level":"manager"},{"full_name":"Mokrani Ilyes ","email":"ilyess.mokrani@zerda.digital","user_id":1835213,"company_id":718573,"level":"user"},{"full_name":"Norchene Zemni ","email":"norchene@zerda.digital","user_id":1531444,"company_id":718573,"level":"user"},{"full_name":"Nourhen Bdioui ","email":"nourhen.bdioui@zerda.digital","user_id":1835553,"company_id":718573,"level":"user"},{"full_name":"Oumaima Belatteg","email":"oumaima.belatteg@zerda.digital","user_id":1830913,"company_id":718573,"level":"user"},{"full_name":"Ouss Romdhane","email":"romdhaneoussama2@gmail.com","user_id":1865297,"company_id":718573,"level":"admin"},{"full_name":"Salsabil Najjar","email":"salsabil.najjar@zerda.digital","user_id":1992398,"company_id":718573,"level":"user"},{"full_name":"Samir Kachouri ","email":"samir@zerda.digital","user_id":1572276,"company_id":718573,"level":"user"},{"full_name":"Sirine Cherif","email":"sirine_cherif@hotmail.fr","user_id":2027949,"company_id":718573,"level":"user"},{"full_name":"Younes Yahmed","email":"younes.yahmed@zerda.digital","user_id":1952789,"company_id":718573,"level":"manager"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":1,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"","password_reset":""},{"full_name":"Imed El Mokhtar","first_name":"Imed","last_name":"El Mokhtar","email":"imed.mokhtar@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2064222","id":2064222,"user_id":2064222,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"3","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2064222/projects?all=1"},"currently_assigned":{"count":"3","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2064222/projects?all=0"}},"tasks":{"all":{"count":14,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2064222/tasks?status=all"},"active":{"count":13,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2064222/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/2064222.jpg","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"20","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"14753418","password_reset":"14753418"},{"full_name":"Ines Sakkat","first_name":"Ines","last_name":"Sakkat","email":"ines.sakkat@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1974362","id":1974362,"user_id":1974362,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"15","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1974362/projects?all=1"},"currently_assigned":{"count":"15","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1974362/projects?all=0"}},"tasks":{"all":{"count":87,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1974362/tasks?status=all"},"active":{"count":87,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1974362/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Joseph Ouko Ongere","first_name":"Joseph","last_name":"Ouko Ongere","email":"joseph@zerda.store","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072305","id":2072305,"user_id":2072305,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"0","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072305/projects?all=1"},"currently_assigned":{"count":"0","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072305/projects?all=0"}},"tasks":{"all":{"count":1,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072305/tasks?status=all"},"active":{"count":1,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2072305/tasks?status=active"}},"work_status":{"code":"online","info":"Content Writing","current_task":{"task_id":"2072304455","task_name":"Content Writing","start_time":"2021-09-29 13:55:24","total_time_worked":7644}},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"20","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Mahmoud Ben Aissa","first_name":"Mahmoud","last_name":"Ben Aissa","email":"mahmoud@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352473","id":1352473,"user_id":1352473,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"89","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352473/projects?all=1"},"currently_assigned":{"count":"82","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352473/projects?all=0"}},"tasks":{"all":{"count":677,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352473/tasks?status=all"},"active":{"count":553,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352473/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[{"full_name":"Ahmed Nabli","email":"ahmed.nabli@zerda.store","user_id":1938707,"company_id":718573,"level":"manager"},{"full_name":"Amal Becha","email":"amal@zerda.digital","user_id":1825018,"company_id":718573,"level":"user"},{"full_name":"Ameni Khamessi","email":"ameni.khamessi@zerda.digital","user_id":1826554,"company_id":718573,"level":"user"},{"full_name":"Amira Br","email":"amira@zerda.digital","user_id":1621162,"company_id":718573,"level":"user"},{"full_name":"Aymen Klidi","email":"aymen@zerda.digital","user_id":1794290,"company_id":718573,"level":"user"},{"full_name":"Bentardeit Khouloud","email":"khouloud.bentardeit@zerda.digital","user_id":1838153,"company_id":718573,"level":"user"},{"full_name":"Chourabi Mohamed","email":"mohamed@zerda.digital","user_id":1808389,"company_id":718573,"level":"user"},{"full_name":"Emna Zribi","email":"emna@zerda.digital","user_id":1808517,"company_id":718573,"level":"user"},{"full_name":"Haithem Laabidi ","email":"htm@zerda.digital","user_id":1572278,"company_id":718573,"level":"manager"},{"full_name":"Hanna Sebai","email":"hanna@zerda.digital","user_id":1634774,"company_id":718573,"level":"manager"},{"full_name":"Ines Sakkat","email":"ines.sakkat@zerda.digital","user_id":1974362,"company_id":718573,"level":"user"},{"full_name":"Mokrani Ilyes ","email":"ilyess.mokrani@zerda.digital","user_id":1835213,"company_id":718573,"level":"user"},{"full_name":"Norchene Zemni ","email":"norchene@zerda.digital","user_id":1531444,"company_id":718573,"level":"user"},{"full_name":"Nourhen Bdioui ","email":"nourhen.bdioui@zerda.digital","user_id":1835553,"company_id":718573,"level":"user"},{"full_name":"Oumaima Belatteg","email":"oumaima.belatteg@zerda.digital","user_id":1830913,"company_id":718573,"level":"user"},{"full_name":"Ouss Romdhane","email":"romdhaneoussama2@gmail.com","user_id":1865297,"company_id":718573,"level":"admin"},{"full_name":"Salsabil Najjar","email":"salsabil.najjar@zerda.digital","user_id":1992398,"company_id":718573,"level":"user"},{"full_name":"Samir Kachouri ","email":"samir@zerda.digital","user_id":1572276,"company_id":718573,"level":"user"},{"full_name":"Sirine Cherif","email":"sirine_cherif@hotmail.fr","user_id":2027949,"company_id":718573,"level":"user"},{"full_name":"Younes Yahmed","email":"younes.yahmed@zerda.digital","user_id":1952789,"company_id":718573,"level":"manager"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"","password_reset":""},{"full_name":"Mokrani Ilyes ","first_name":"Mokrani ","last_name":"Ilyes ","email":"ilyess.mokrani@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835213","id":1835213,"user_id":1835213,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"2","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835213/projects?all=1"},"currently_assigned":{"count":"2","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835213/projects?all=0"}},"tasks":{"all":{"count":704,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835213/tasks?status=all"},"active":{"count":660,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835213/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Norchene Zemni ","first_name":"Norchene Zemni","last_name":"","email":"norchene@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1531444","id":1531444,"user_id":1531444,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"24","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1531444/projects?all=1"},"currently_assigned":{"count":"22","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1531444/projects?all=0"}},"tasks":{"all":{"count":135,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1531444/tasks?status=all"},"active":{"count":88,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1531444/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-05-18","employee_id":null,"password_reset":null},{"full_name":"Nourhen Bdioui ","first_name":"Nourhen ","last_name":"Bdioui ","email":"nourhen.bdioui@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835553","id":1835553,"user_id":1835553,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"11","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835553/projects?all=1"},"currently_assigned":{"count":"11","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835553/projects?all=0"}},"tasks":{"all":{"count":33,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835553/tasks?status=all"},"active":{"count":23,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1835553/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-04-23","employee_id":null,"password_reset":null},{"full_name":"Oumaima Belatteg","first_name":"Oumaima","last_name":"Belatteg","email":"oumaima.belatteg@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1830913","id":1830913,"user_id":1830913,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"6","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1830913/projects?all=1"},"currently_assigned":{"count":"6","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1830913/projects?all=0"}},"tasks":{"all":{"count":1186,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1830913/tasks?status=all"},"active":{"count":1142,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1830913/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Ouss Romdhane","first_name":"Ouss","last_name":"Romdhane","email":"romdhaneoussama2@gmail.com","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1865297","id":1865297,"user_id":1865297,"company_id":718573,"level":"admin","is_team_manager":false,"projects":{"all":{"count":"238","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1865297/projects?all=1"},"currently_assigned":{"count":"0","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1865297/projects?all=0"}},"tasks":{"all":{"count":3,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1865297/tasks?status=all"},"active":{"count":3,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1865297/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[{"full_name":"Ahmed Nabli","email":"ahmed.nabli@zerda.store","user_id":1938707,"company_id":718573,"level":"manager"},{"full_name":"Ali Gassab","email":"ali@zerda.store","user_id":1429386,"company_id":718573,"level":"manager"},{"full_name":"Amal Becha","email":"amal@zerda.digital","user_id":1825018,"company_id":718573,"level":"user"},{"full_name":"Ameni Khamessi","email":"ameni.khamessi@zerda.digital","user_id":1826554,"company_id":718573,"level":"user"},{"full_name":"Amira Br","email":"amira@zerda.digital","user_id":1621162,"company_id":718573,"level":"user"},{"full_name":"Aymen Klidi","email":"aymen@zerda.digital","user_id":1794290,"company_id":718573,"level":"user"},{"full_name":"Bentardeit Khouloud","email":"khouloud.bentardeit@zerda.digital","user_id":1838153,"company_id":718573,"level":"user"},{"full_name":"Chiheb Ben Aissa ","email":"chiheb@zerda.digital","user_id":1352467,"company_id":718573,"level":"admin"},{"full_name":"Chourabi Mohamed","email":"mohamed@zerda.digital","user_id":1808389,"company_id":718573,"level":"user"},{"full_name":"Emna Zribi","email":"emna@zerda.digital","user_id":1808517,"company_id":718573,"level":"user"},{"full_name":"Haithem Laabidi ","email":"htm@zerda.digital","user_id":1572278,"company_id":718573,"level":"manager"},{"full_name":"Hanna Sebai","email":"hanna@zerda.digital","user_id":1634774,"company_id":718573,"level":"manager"},{"full_name":"Imed El Mokhtar","email":"imed.mokhtar@zerda.digital","user_id":2064222,"company_id":718573,"level":"user"},{"full_name":"Ines Sakkat","email":"ines.sakkat@zerda.digital","user_id":1974362,"company_id":718573,"level":"user"},{"full_name":"Joseph Ouko Ongere","email":"joseph@zerda.store","user_id":2072305,"company_id":718573,"level":"user"},{"full_name":"Mahmoud Ben Aissa","email":"mahmoud@zerda.digital","user_id":1352473,"company_id":718573,"level":"manager"},{"full_name":"Mokrani Ilyes ","email":"ilyess.mokrani@zerda.digital","user_id":1835213,"company_id":718573,"level":"user"},{"full_name":"Norchene Zemni ","email":"norchene@zerda.digital","user_id":1531444,"company_id":718573,"level":"user"},{"full_name":"Nourhen Bdioui ","email":"nourhen.bdioui@zerda.digital","user_id":1835553,"company_id":718573,"level":"user"},{"full_name":"Oumaima Belatteg","email":"oumaima.belatteg@zerda.digital","user_id":1830913,"company_id":718573,"level":"user"},{"full_name":"Sabbir Ahmed","email":"sabbir25112@gmail.com","user_id":2072890,"company_id":718573,"level":"admin"},{"full_name":"Salsabil Najjar","email":"salsabil.najjar@zerda.digital","user_id":1992398,"company_id":718573,"level":"user"},{"full_name":"Samir Kachouri ","email":"samir@zerda.digital","user_id":1572276,"company_id":718573,"level":"user"},{"full_name":"Sirine Cherif","email":"sirine_cherif@hotmail.fr","user_id":2027949,"company_id":718573,"level":"user"},{"full_name":"Younes Yahmed","email":"younes.yahmed@zerda.digital","user_id":1952789,"company_id":718573,"level":"manager"},{"full_name":"Zidane Yassine","email":"yassine.zidane@zerda.digital","user_id":1872916,"company_id":718573,"level":"manager"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-10-02","employee_id":null,"password_reset":null},{"full_name":"Salsabil Najjar","first_name":"Salsabil","last_name":"Najjar","email":"salsabil.najjar@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1992398","id":1992398,"user_id":1992398,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"11","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1992398/projects?all=1"},"currently_assigned":{"count":"11","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1992398/projects?all=0"}},"tasks":{"all":{"count":52,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1992398/tasks?status=all"},"active":{"count":52,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1992398/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"salsabil.najjar@zerda.digital","password_reset":"salsabil.najjar@zerda.digital"},{"full_name":"Samir Kachouri ","first_name":"Samir Kachouri","last_name":"","email":"samir@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572276","id":1572276,"user_id":1572276,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"35","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572276/projects?all=1"},"currently_assigned":{"count":"33","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572276/projects?all=0"}},"tasks":{"all":{"count":157,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572276/tasks?status=all"},"active":{"count":106,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1572276/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"300","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":null,"password_reset":null},{"full_name":"Sirine Cherif","first_name":"Sirine","last_name":"Cherif","email":"sirine_cherif@hotmail.fr","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2027949","id":2027949,"user_id":2027949,"company_id":718573,"level":"user","is_team_manager":false,"projects":{"all":{"count":"6","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2027949/projects?all=1"},"currently_assigned":{"count":"6","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2027949/projects?all=0"}},"tasks":{"all":{"count":46,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2027949/tasks?status=all"},"active":{"count":8,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/2027949/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"9","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"","password_reset":""},{"full_name":"Younes Yahmed","first_name":"Younes","last_name":"Yahmed","email":"younes.yahmed@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1952789","id":1952789,"user_id":1952789,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"27","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1952789/projects?all=1"},"currently_assigned":{"count":"27","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1952789/projects?all=0"}},"tasks":{"all":{"count":142,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1952789/tasks?status=all"},"active":{"count":141,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1952789/tasks?status=active"}},"work_status":{"code":"offline","info":"Offline"},"managed_users":[{"full_name":"Bentardeit Khouloud","email":"khouloud.bentardeit@zerda.digital","user_id":1838153,"company_id":718573,"level":"user"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/small_avatar.png","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"active","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2021-09-29","employee_id":"Yahmed","password_reset":"Yahmed"},{"full_name":"Zidane Yassine","first_name":"Zidane","last_name":"Yassine","email":"yassine.zidane@zerda.digital","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1872916","id":1872916,"user_id":1872916,"company_id":718573,"level":"manager","is_team_manager":true,"projects":{"all":{"count":"19","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1872916/projects?all=1"},"currently_assigned":{"count":"19","url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1872916/projects?all=0"}},"tasks":{"all":{"count":68,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1872916/tasks?status=all"},"active":{"count":60,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1872916/tasks?status=active"}},"work_status":{"code":"not-active","info":"Not yet activated"},"managed_users":[{"full_name":"Amira Br","email":"amira@zerda.digital","user_id":1621162,"company_id":718573,"level":"user"},{"full_name":"Haithem Laabidi ","email":"htm@zerda.digital","user_id":1572278,"company_id":718573,"level":"manager"}],"teams":[],"new_user":0,"team_status":"","payroll_access":0,"billing_access":0,"avatar":"https://s3.amazonaws.com/tds3_avatars/1872916.jpg","screenshots_active":"1","manual_time":"1","permanent_tasks":0,"computer_time_popup":"540","poor_time_popup":"1","blur_screenshots":0,"web_and_app_monitoring":"1","webcam_shots":0,"screenshots_interval":"6","user_role_value":null,"status":"deactivated","reports_hidden":false,"time_tracking_started":null,"managed_by":[],"last_active_date":"2020-09-10","employee_id":null,"password_reset":null}]', true);
        Logger::verbose("start getUsers with try#". $try);

        if ($try > self::MAX_TRY) return [];

        $settings = Settings::timedoctor();
        $access_token = $settings->access_token;
        $api = env('TIME_DOCTOR_BASE_URL') . '/companies/' . env('TIME_DOCTOR_COMPANY_ID') . '/users';
        $request = Http::get($api, [
            'access_token' => $access_token
        ]);

        if ($request->successful()) {
            Logger::info("successfully got users from time-doctor");
            $response = $request->json();
            return $response['users'];
        }
        if ($request->failed() && $request->status() == self::UNAUTHENTICATED_STATUS_CODE) {
            Logger::error("something went wrong with status code " . self::UNAUTHENTICATED_STATUS_CODE);
            $is_regenerated = self::setAccessToken($settings);
            if ($is_regenerated) {
                return self::getUsers(++$try);
            }
        }

        Logger::error("something went wong with status code ". $request->status());
        return [];
    }

    public static function getTaskFromWorkLog(WorklogMapper $workLog)
    {
        $call_count = 0;
        $time_doctor_response = json_decode($workLog->time_doctor_response, true);
        $taskId = $time_doctor_response['task_id'];
        $task = TaskMapper::where("time_doctor_task_id", $taskId)->first();
        if ($task == null)
        {
            $userId = $time_doctor_response['user_id'];
            $settings = Settings::timedoctor();
            $access_token = $settings->access_token;

            $api = env('TIME_DOCTOR_BASE_URL') . '/companies/' . env('TIME_DOCTOR_COMPANY_ID') . "/users/$userId/tasks/$taskId";

            $request = Http::get($api, [
                'access_token'  => $access_token,
            ]);
            $call_count++;

            if ($request->successful())
            {
                $response = $request->json();
                // $response = json_decode('{"id":69809418,"task_id":69809418,"project_id":16836083,"project_name":"NeXafe Général","task_name":"Plan marketing 2021","active":true,"user_id":1352467,"assigned_by":1352467,"url":"https://webapi.timedoctor.com/v1.1/companies/718573/users/1352467/tasks/69809418","task_link":"https://app.clickup.com/t/but930","status":"Active"}', true);
                $taskUrl = $response['task_link'];
                if ($taskUrl == null) return [
                    'task' => null,
                    'call_count' => $call_count
                ];
                Logger::info($taskUrl);
                $clickUpTaskId = self::getClickUpTaskIdFromUrl($taskUrl);

                $task = TaskMapper::where(function ($query) use ($clickUpTaskId, $taskUrl) {
                    return $query->where('click_up_task_id', $clickUpTaskId)->orWhere('click_task_url', $taskUrl);
                })->first();

                if ($task == null) {
                    $taskResponse = ClickUpFetcher::getTask($clickUpTaskId);
                    if ($taskResponse != null) {
                        ClickUpSyncer::syncTasks([$taskResponse]);
                    }

                    $task = TaskMapper::where(function ($query) use ($clickUpTaskId, $taskUrl) {
                        return $query->where('click_up_task_id', $clickUpTaskId)->orWhere('click_task_url', $taskUrl);
                    })->first();
                }

                if ($task != null) {
                    $task->update([
                        'time_doctor_task_id' => $taskId,
                        'time_doctor_response'=> json_encode($response)
                    ]);
                }
            }
        }
        return [
            'task' => $task,
            'call_count' => $call_count
        ];
    }

    public static function getUserFromWorkLog(WorklogMapper $workLog)
    {
        $time_doctor_response = json_decode($workLog->time_doctor_response, true);
        $userId = $time_doctor_response['user_id'];
        $user = UserMapper::where('time_doctor_user_id', $userId)
            ->whereNotNull('click_up_user_id')
            ->first();
        return $user;
    }

    public static function setAccessToken(Settings $settings)
    {
        Logger::info("trying to regenerate access token");

        $refresh_token = $settings->refresh_token;
        $api = 'https://webapi.timedoctor.com/oauth/v2/token';
        $request = Http::get($api, [
            'client_id' => env('TIME_DOCTOR_CLIENT_ID'),
            'client_secret' => env('TIME_DOCTOR_CLIENT_SECRET'),
            'grant_type' => 'refresh_token',
            'refresh_token' => $refresh_token,
        ]);

        if ($request->successful()) {
            $response = $request->json();

            $settings->update([
                'access_token'  => $response['access_token'],
                'refresh_token' => $response['refresh_token'],
            ]);
            Logger::info("time-doctor access token generated successfully");
            return true;
        }
        Logger::error("can't generate access token properly. please try manually");
        return false;
    }

    public static function getClickUpTaskIdFromUrl($url)
    {
        $url_sections = explode('/', $url);
        return end($url_sections);
    }
}
